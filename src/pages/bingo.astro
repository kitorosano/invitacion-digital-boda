---
import { actions } from "astro:actions";
import { getCollection } from "astro:content";
import Board from "../components/bingo/Board";
import Instructions from "../components/bingo/Instructions.astro";
import RegisterUser from "../components/bingo/RegisterUser.astro";
import {
  instructionsProps,
  layoutProps,
  registerUserProps,
} from "../constants/bingo";
import BingoLayout from "../layouts/BingoLayout.astro";

let user = null;
const hasCookie = Astro.cookies.has("userId");

if (hasCookie) {
  const { data, error } = await Astro.callAction(actions.getCurrentUser, {});
  if (error) {
    await Astro.callAction(actions.unregisterUser, {});
  }
  if (data) {
    user = data.user;
  }
}

const optionalTasks = await getCollection("optionalTasks");
const mandatoryTasks = await getCollection("mandatoryTasks");
const boardProps = {
  optionalTasks: optionalTasks.map((task) => task.data),
  mandatoryTasks: mandatoryTasks.map((task) => task.data),
};
---

<BingoLayout {...layoutProps}>
  <Instructions {...instructionsProps} isLogged={!!user} />
  {
    !user ? (
      <RegisterUser {...registerUserProps} />
    ) : (
      <Board {...boardProps} user={user} client:load />
    )
  }
</BingoLayout>
